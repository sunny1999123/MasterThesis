
```{r }
library(shiny)
library(data.table)
library(httr)
library(jsonlite)
library(stringr)
library(dplyr)


#Get CIK symbols per ticker and make a dataframe of it from SEC api
INFO <- read_json("https://www.sec.gov/files/company_tickers.json")
INFO <- rbindlist(INFO)

#Add zero's before CIK, needed for API and store as data frame
INFO$CIK = do.call(rbind, lapply(as.list(1:nrow(INFO)), function(ii){
  ZEROS = 10-as.numeric(str_count(INFO$cik_str[ii]))
  paste0(c(rep(0,ZEROS),INFO$cik_str[ii]), collapse = "")
}))
INFO <- as.data.frame(INFO)

#Create function that takes ticker as input and gives CIK as output. Including test
getCIK = function(symbol){
  subset(INFO, INFO$ticker == paste(symbol))$CIK
}

#Create function that retrieves
DataAccess = function(ticker, year){
  CIK = getCIK(ticker)
  url <- paste0("https://data.sec.gov/api/xbrl/companyfacts/CIK",CIK,".json")
  pg <- GET(url = url,
            config = httr::add_headers(`User-Agent` = "Sunny Bhatia 590913ab@student.eur.nl",
                                       `Accept-Encoding` = 'gzip, deflate'))
  data_raw <- try(content(pg, as = "text", encoding = "UTF-8") %>% fromJSON(flatten = TRUE), silent = TRUE)
  N = length(data_raw$facts$dei)
  if(N >= 1)
  {
    DEI = rbindlist(lapply(as.list(1:N), function(ii){
      # extract data
      tmp = as.data.frame(rbindlist(data_raw$facts$dei[[ii]]$units[[1]],use.names = TRUE, fill = TRUE))
      # add description column
      tmp$desc <- names(data_raw$facts$dei)[ii]
      # delete duplicates
      tmp <- tmp[!duplicated(tmp$end),]
      # add ticker column
      tmp$symbol <- ticker
      # return df
      filter(tmp, form=="10-K",fy==year, substr(end,1,4)==year)
    }),use.names=TRUE, fill=TRUE)}else{
      DEI = NULL
    }
  N = length(data_raw$facts$`us-gaap`)
  if(N >= 1)
  {
    GAAP = rbindlist(lapply(as.list(1:N), function(ii){
      # extract data
      tmp = as.data.frame(rbindlist(data_raw$facts$`us-gaap`[[ii]]$units[[1]],use.names = TRUE, fill = TRUE))
      # add description column
      tmp$desc <- names(data_raw$facts$`us-gaap`)[ii]
      # delete duplicates
      tmp <- tmp[!duplicated(tmp$end),]
      # add ticker column
      tmp$symbol <- ticker
      # return df
      filter(tmp, form=="10-K",fy==year, substr(end,1,4)==year)
    }),use.names=TRUE, fill=TRUE)
    # re-order
    GAAP = GAAP[,c("start","end","val","accn","fy","fp","form","filed","frame","desc","symbol" )]
  }else{
    GAAP = NULL
  }
  N = length(data_raw$facts$invest)
  if(N >= 1)
  {
    INVEST = rbindlist(lapply(as.list(1:N), function(ii){
      # extract data
      tmp = as.data.frame(rbindlist(data_raw$facts$invest[[ii]]$units[[1]],use.names = TRUE, fill = TRUE))
      # add description column
      tmp$desc <- names(data_raw$facts$invest)[ii]
      # delete duplicates
      tmp <- tmp[!duplicated(tmp$end),]
      # add ticker column
      tmp$symbol <- ticker
      # return df
      filter(tmp, form=="10-K",fy==year, substr(end,1,4)==year)
    }),use.names=TRUE, fill=TRUE)
  }else{
    INVEST = NULL
  }
  N = length(data_raw$facts$srt)
  if(N >= 1)
  {
    SRT = rbindlist(lapply(as.list(1:N), function(ii){
      # extract data
      tmp = as.data.frame(rbindlist(data_raw$facts$srt[[ii]]$units[[1]],use.names = TRUE, fill = TRUE))
      # add description column
      tmp$desc <- names(data_raw$facts$srt)[ii]
      # delete duplicates
      tmp <- tmp[!duplicated(tmp$end),]
      # add ticker column
      tmp$symbol <- ticker
      # return df
      filter(tmp, form=="10-K",fy==year, substr(end,1,4)==year)
    }),use.names=TRUE, fill=TRUE)
  }else{
    SRT = NULL
  }
  # combine ALL data
  ALL <- rbind.fill(GAAP,DEI,SRT,INVEST)
  # return data frame
  ALL
}

DataAccess <- function(ticker, year) {
  CIK <- getCIK(ticker)
  url <- paste0("https://data.sec.gov/api/xbrl/companyfacts/CIK", CIK, ".json")
  pg <- GET(url = url,
            config = httr::add_headers(`User-Agent` = "Sunny Bhatia 590913ab@student.eur.nl",
                                       `Accept-Encoding` = "gzip, deflate"))
  data_raw <- tryCatch({
    content(pg, as = "text", encoding = "UTF-8") %>% fromJSON(flatten = TRUE)
  }, error = function(e) {
    return(NULL)
  })
  
  if (is.null(data_raw)) {
    return(NULL)
  }
  
  DEI <- NULL
  if ("dei" %in% names(data_raw$facts)) {
    N <- length(data_raw$facts$dei)
    if (N >= 1) {
      DEI <- rbindlist(lapply(seq_len(N), function(ii) {
        tmp <- as.data.frame(rbindlist(data_raw$facts$dei[[ii]]$units[[1]], use.names = TRUE, fill = TRUE))
        tmp$desc <- names(data_raw$facts$dei)[ii]
        tmp <- tmp[!duplicated(tmp$end), ]
        tmp$symbol <- ticker
        filter(tmp, form == "10-K", fy == year, substr(end, 1, 4) == year)
      }), use.names = TRUE, fill = TRUE)
    }
  }
  
  GAAP <- NULL
  if ("us-gaap" %in% names(data_raw$facts)) {
    N <- length(data_raw$facts$"us-gaap")
    if (N >= 1) {
      GAAP <- rbindlist(lapply(seq_len(N), function(ii) {
        tmp <- as.data.frame(rbindlist(data_raw$facts$"us-gaap"[[ii]]$units[[1]], use.names = TRUE, fill = TRUE))
        tmp$desc <- names(data_raw$facts$"us-gaap")[ii]
        tmp <- tmp[!duplicated(tmp$end), ]
        tmp$symbol <- ticker
        filter(tmp, form == "10-K", fy == year, substr(end, 1, 4) == year)
      }), use.names = TRUE, fill = TRUE)
    }
  }
  
  INVEST <- NULL
  if ("invest" %in% names(data_raw$facts)) {
    N <- length(data_raw$facts$invest)
    if (N >= 1) {
      INVEST <- rbindlist(lapply(seq_len(N), function(ii) {
        tmp <- as.data.frame(rbindlist(data_raw$facts$invest[[ii]]$units[[1]], use.names = TRUE, fill = TRUE))
        tmp$desc <- names(data_raw$facts$invest)[ii]
        tmp <- tmp[!duplicated(tmp$end), ]
        tmp$symbol <- ticker
        filter(tmp, form == "10-K", fy == year, substr(end, 1, 4) == year)
      }), use.names = TRUE, fill = TRUE)
    }
  }
  
  SRT <- NULL
  if ("srt" %in% names(data_raw$facts)) {
    N <- length(data_raw$facts$srt)
    if (N >= 1) {
      SRT <- rbindlist(lapply(seq_len(N), function(ii) {
        tmp <- as.data.frame(rbindlist(data_raw$facts$srt[[ii]]$units[[1]], use.names = TRUE, fill = TRUE))
        tmp$desc <- names(data_raw$facts$srt)[ii]
        tmp <- tmp[!duplicated(tmp$end), ]
        tmp$symbol <- ticker
        filter(tmp, form == "10-K", fy == year, substr(end, 1, 4) == year)
      }), use.names = TRUE, fill = TRUE)
    }
  }
  
  ALL <- rbind.fill(GAAP, DEI, SRT, INVEST)
  ALL
}






















ui <- fluidPage(
  titlePanel("Data Access App"),
  sidebarLayout(
    sidebarPanel(
      textInput("ticker", "Ticker Symbol:"),
      numericInput("year", "Year:", value = NULL)
    ),
    mainPanel(
      tableOutput("resultTable")
    )
  )
)

server <- function(input, output) {
  output$resultTable <- renderTable({
    ticker <- input$ticker
    year <- input$year
    if (is.null(year)) {
      # Handle case when year is not provided
      return(NULL)
    }
    DataAccess(ticker, year)
  })
}




shinyApp(ui = ui, server = server)
```



---
title: 9.New-Firm-Analysis.R
author: sunny
date: '2023-05-17'

---
